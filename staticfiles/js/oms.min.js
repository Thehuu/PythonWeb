(function(global) {
    function OverlappingMarkerSpiderfier(map, options) {
        this.map = map;
        this.markers = [];
        this.spiderfied = false;
        this.options = options || {};
    }

    OverlappingMarkerSpiderfier.prototype.addMarker = function(marker) {
        this.markers.push(marker);
        var self = this;
        marker.addListener('click', function() {
            self.spiderfy(marker);
        });
    };

    OverlappingMarkerSpiderfier.prototype.spiderfy = function(marker) {
        if (this.spiderfied) return;
        this.spiderfied = true;
        var offset = 0.00005; // Khoảng cách nhỏ để tách marker
        this.markers.forEach(function(m, index) {
            if (m !== marker) {
                var pos = m.getPosition();
                m.setPosition({ lat: pos.lat() + offset * index, lng: pos.lng() });
            }
        });
    };

    OverlappingMarkerSpiderfier.prototype.unspiderfy = function() {
        this.spiderfied = false;
    };

    global.OverlappingMarkerSpiderfier = OverlappingMarkerSpiderfier;
})(window);
